---
layout: post
title:  "IPv6部署经验分享"
date:   2020-01-06 15:29:36 +0530
description: 经验分享 
categories: 经验分享 IPv6
---

本人在部署ipv6时，遇到过很多比较典型的问题，由于某些故障例没有留存排查过程的数据或项目紧急等等原因，最终没有进行梳理形成文档。
在这里简单说下自身对于ipv6部署的经验，避免大家再次采坑。

### 需要重点关注点如下

1.网络设备表项容量问题

由于ipv6地址段最长为128位，因此网络设备在存v6表项时与存v4表项有所不同。交换机通过调整不同的运行方式，来实现以不同的方式来存储v4和v6的表项。

以某厂商 TD3交换机表项规格为例：
下表中，双栈模式，v4v6规格不共享；其他模式，v4v6规格共享

![图1](https://raw.githubusercontent.com/NetprogDong/image_repo/master/image_blog/FB7841E1-8D31-4126-B32F-CC018A0D2017.png "图1")

2.ipv6协议相关的交换机bug

各厂商网络设备已在很早之前就全面支持ipv6协议，但由于国内大规模部署ipv6的动作是近两年才开始的，网络设备严重缺乏真实业务浸泡环节，再结合互联网企业的业务多元化，业务实现逻辑丰富，再加上业务侧也是首次增加ipv6协议栈支持，因此不免在ipv6测试、灰度阶段出现各种各样的问题。本人在推进部署ipv6时遇到了很多问题，这些问题中有很大一部分是由于使用场景的多样化(设备厂商研发并未考虑到)，导致网络设备出现一些异常行为，这里统一称为交换机软件层面bug。

因此为了规避、解决这些问题，在前期测试、灰度阶段一定要拉着业务方进行充分的测试，最大程度避免上线后再发现问题。

3.ipv6公网资源质量问题

由于当前国内ipv6仍在"生长"阶段，因此运营商各地市的支持程度以及各家公司的支持程度都不同。ISP国干、省干以及核心地市、几大云厂商是率先全面支持ipv6并能保证访问质量的，但是其他公司的实现速度就相差很大了。因此，在业务需要调用第三方公网ipv6资源时，并不能保证访问质量，延时抖动和丢包、不通在所难免。此时，可以通过业务侧做探测、修改v4/v6协议栈优先级等方式对访问质量不佳的目的端做规避。

4.ipv6网络改造

基于ipv6快速部署以及成本两方面的考虑，大部分公司在部署ipv6时都会复用现有资源以双栈方式将ipv6部署在原有机房网络，也就是改造而不是新建。

- 网络改造要面对的问题是
1. 改造前后不能破坏原有ipv4的网络环境，做到ipv4业务无感知。
2. 大规模ipv6配置下发尽量使用自动化下发工具(如：netconf、python脚本等)，避免人为错误发生影响现网业务。
3. ipv6地址规划一定要有规律、扩展性要强，最好有相应的平台以便做记录、备份和系统间网段数据的调用。地址规划跟各公司网络规划、业务规划、机房规划等强相关，在此不做具体举例。
